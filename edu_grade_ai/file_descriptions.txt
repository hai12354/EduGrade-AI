MÔ TẢ CHI TIẾT CÁCH HOẠT ĐỘNG VÀ CÁC FILE TRONG DỰ ÁN

1. THƯ MỤC GỐC (lib/)
- main.dart: ================================================================================
STRUCTURE OVERVIEW (UPDATED - BACKEND FIRST ARCHITECTURE)
================================================================================

This project follows a "Backend First" architecture where the Flutter Frontend (FE) 
communicates exclusively with the Python FastAPI Backend (BE) via REST APIs. 
Direct Firebase connections from the Frontend have been removed for security and consistency.

ROOT
├── BE/                          # [Backend] Python FastAPI Server (Main Logic & Database)
│   ├── routers/                 # API Endpoints (Controllers)
│   │   ├── users_router.py      # Authentication, Profile, Teachers List
│   │   ├── classes_router.py    # Class Management, Registration, Enrollment
│   │   ├── exams_router.py      # Exam Creation, Question Bank, Results
│   │   ├── settings_router.py   # System Settings (Deadlines, Semesters)
│   │   ├── ai_router.py         # AI Exam Generation (Gemini/Grok/OpenAI)
│   │   └── auth_router.py       # (Legacy/Internal) Token Verification
│   ├── services/                # Business Logic Services
│   │   ├── firebase_service.py  # [CORE] Handles connection to Firestore & Auth
│   │   └── ai_service.py        # Wrapper for Generative AI SDKs
│   ├── models/                  # Pydantic Data Models
│   ├── main.py                  # Entry Point - Server Configuration & Auto-Discovery
│   └── serviceAccountKey.json   # [CRITICAL] Firebase Admin Credentials (Required)
│
├── edu_grade_ai/                # [Frontend] Flutter Mobile/Web App (UI Layer)
│   ├── lib/
│   │   ├── services/
│   │   │   └── api_service.dart # [CORE] Central API Client. Replaces all direct DB calls.
│   │   ├── screens/             # UI Screens
│   │   │   ├── auth_screen.dart # Login/Register (Calls BE API)
│   │   │   ├── teacher/         # Teacher-specific screens (Exam generation, etc)
│   │   │   └── ...
│   │   ├── models/              # Dart Data Models (Mapped to Backend JSON)
│   │   └── main.dart            # App Entry Point (Simplified, no Firebase Init)
│   └── pubspec.yaml             # Dependencies (http, flutter_dotenv, etc)
ộng màn hình (ngưỡng 850px).

- admin_classes_screen.dart:
  + Logic: Quản lý lớp học real-time qua `StreamBuilder`. Tích hợp logic kiểm tra hạn chót đăng ký (deadline) từ collection `settings` để đóng/mở nút đăng ký đối với sinh viên.

- teacher_management_page.dart: 
  + Logic: Tạo tài khoản giáo viên mới. Mật khẩu mặc định là "123". Dữ liệu được lưu thẳng vào collection `users` kèm role là 'teacher'.

- system_settings_page.dart: 
  + Logic: Quản lý biến cấu hình chung. Cho phép Admin khóa cổng đăng ký thủ công hoặc đặt lịch deadline. Dữ liệu lưu trong collection `settings` dưới ID `registration_[semesterID]`.

- user_profile_update.dart:
  + Logic: Xử lý cập nhật thông tin cá nhân. Tính toán và lưu Ngày sinh dưới dạng `Timestamp` của Cloud Firestore để dễ dàng tính tuổi hoặc xuất báo cáo.

- exam_execution_page.dart:
  + Logic: Khi nộp bài, app thực hiện tính điểm "offline" trước bằng cách so sánh Map câu trả lời của sinh viên với đáp án đúng trong Question Object, sau đó lưu toàn bộ bản ghi kết quả (bao gồm chi tiết từng câu trả lời) vào collection `exam_results`.

- exam_results_page.dart:
  + Logic: Sử dụng thư viện `excel` để tạo file .xlsx động từ dữ liệu Firestore. 
  + Xử lý đa nền tảng: Trên Web sử dụng `AnchorElement` để download file qua base64, trên Mobile sử dụng `path_provider` và `share_plus` để mở hộp thoại chia sẻ file.

- theme_controller.dart:
  + Logic: Sử dụng `ChangeNotifier` để lưu trạng thái Dark/Light mode và thông báo cho toàn bộ Widget Tree cập nhật màu sắc ngay lập tức mà không cần load lại trang.

2. MODELS (lib/models/)
- class_model.dart: Chứa logic parse chuỗi `schedule` phức tạp (Thứ | Tiết | Phòng | Ngày) từ Firestore thành các thuộc tính riêng biệt của ClassModel.
- student_model.dart: Quản lý việc ánh xạ (mapping) danh sách môn học (`List<String>`) từ mảng trong Firestore sang danh sách trong Dart.
- question_model.dart: Cấu trúc câu hỏi linh hoạt, hỗ trợ cả `trac_nghiem` (kèm 4 đáp án trong content) và `tu_luan` (kèm rubric).

3. SERVICES (lib/services/)
- database_service.dart: Chứa các tác vụ nguyên tử (atomic tasks) như kiểm tra sự tồn tại của Username, cập nhật mật khẩu cũ.
- class_service.dart: 
  + Logic: Sử dụng `runTransaction` của Firestore cho việc Đăng ký lớp. Điều này đảm bảo sĩ số (`currentSlots`) không bao giờ vượt quá `maxSlots` ngay cả khi có nhiều người nhấn đăng ký cùng lúc.

4. SCREENS (lib/screens/)
- student/student_exams_page.dart: Truy vấn collection `exams` để lấy các đề thi theo môn học mà giáo viên đã tạo.
- teacher/syllabus_page.dart: 
  + Logic AI: Triển khai chiến lược "AI Fallback". Đầu tiên dùng Gemini, nếu lỗi (mã 503/overloaded) sẽ tự động quay vòng thử lại (retry), nếu vẫn lỗi sẽ chuyển sang Grok, và cuối cùng là OpenAI. 
  + Prompt: Sử dụng System Prompt chuyên biệt để ép AI trả về dữ liệu theo định dạng text có cấu trúc để parser có thể bóc tách thành danh sách câu hỏi.

5. WIDGETS (lib/widgets/)
- class_card.dart: Tích hợp logic hiển thị khác nhau dựa trên vai trò người dùng (Admin thấy nút Sửa/Xóa, Student thấy nút Đăng ký, Teacher thấy danh sách lớp mình dạy).
